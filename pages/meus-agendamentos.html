<!DOCTYPE html>
<html lang="pt-BR" class="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Meus Agendamentos • Coordena+</title>

  <!-- Favicon -->
  <link rel="icon" href="../assets/img/logo.png" type="image/png" />

  <!-- PWA / full-screen on mobile -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#2563EB" />
  <link rel="manifest" href="../manifest.json" />

  <!-- Tailwind + Dark Mode -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Aplica imediatamente o tema salvo (evita flash) -->
  <script>
    const _theme = localStorage.getItem('theme') || 'light';
    document.documentElement.classList.remove('light');
    if (_theme === 'dark') document.documentElement.classList.add('dark');
  </script>

  <link rel="stylesheet" href="../assets/css/styles.css" />

  <!-- Auth library -->
  <script src="../assets/js/auth.js"></script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-500">

  <!-- Proteção de rota: redireciona ao login se não houver usuário logado -->
  <script>
    const user = Auth.getCurrentUser();
    if (!user) {
      // Se não houver usuário, redireciona para a página de login
      window.location.href = '../login.html';
    } else {
      // Para uso nos outros scripts
      window.user = user;
    }
  </script>

  <!-- Off-Canvas Menu -->
  <header class="offcanvas-menu">
    <input type="checkbox" id="toggle-menu" />

    <!-- Ícone hambúrguer / X -->
    <label for="toggle-menu" class="toggle-open"></label>

    <nav>
      <!-- Usuário logado -->
      <div class="menu-user-info p-4">
        <div id="menu-user-name" class="font-semibold"></div>
        <div id="menu-user-email" class="text-sm text-gray-600 dark:text-gray-400"></div>
      </div>

      <!-- Botão de fechar (X) -->
      <label for="toggle-menu" class="toggle-close"></label>

      <!-- Lista de navegação: apenas “Meus Agendamentos” -->
      <ul class="menu-list p-4 space-y-2">
        <li>
          <a href="meus-agendamentos.html"
             class="block text-lg font-medium text-gray-800 dark:text-gray-200 hover:text-blue-500">
            Meus Agendamentos
          </a>
        </li>
      </ul>

      <!-- Botões Tema / Sair -->
      <div class="menu-footer-btns p-4 flex space-x-4">
        <!-- Botão Tema -->
        <button id="menu-theme-btn" class="footer-btn" aria-label="Alternar tema">
          <!-- Ícone Sol -->
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sun h-6 w-6" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5" />
            <line x1="12" y1="1" x2="12" y2="3" />
            <line x1="12" y1="21" x2="12" y2="23" />
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
            <line x1="1" y1="12" x2="3" y2="12" />
            <line x1="21" y1="12" x2="23" y2="12" />
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
          </svg>
          <!-- Ícone Lua -->
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-moon h-6 w-6" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 0111.21 3 7 7 0 0012 21a9 9 0 009-8.21z" />
          </svg>
        </button>

        <!-- Botão Logout -->
        <button id="menu-logout-btn" class="footer-btn logout" aria-label="Sair">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-logout h-6 w-6" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
        </button>
      </div>
    </nav>
  </header>

  <!-- Quick Access (botões flutuantes no topo) -->
  <div
    class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 bg-opacity-60 backdrop-blur-md rounded-full p-2 flex space-x-4 z-40">
    <a href="../index.html"
      class="p-2 bg-gray-700 rounded-full hover:bg-gray-600 transform hover:scale-110 transition duration-200"
      title="Início">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
           stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 12l9-9 9 9m-1 9h-4a2 2 0 01-2-2v-5H9v5a2 2 0 01-2 2H5" />
      </svg>
    </a>
    <button
      class="p-2 bg-blue-500 rounded-full hover:scale-110 transform transition duration-200"
      title="Agendamentos">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
           stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0
                 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    </button>
  </div>

  <!-- Main content -->
  <main class="pt-24 pb-8 mx-auto max-w-4xl px-4 space-y-8">

    <h1 class="text-3xl font-semibold text-center">Meus Agendamentos</h1>

    <div id="agendamentos-container" class="space-y-4">
      <p class="text-center text-gray-600 dark:text-gray-400">Carregando agendamentos...</p>
    </div>

    <footer class="text-center text-sm text-gray-600 dark:text-gray-400 pb-6">
      Copyright© 2025 – Nexus Devsystem – Todos os direitos reservados.
    </footer>
  </main>

  <script>
    (async () => {
      // Exibe nome e e-mail no menu
      document.getElementById('menu-user-name').textContent = user.name;
      document.getElementById('menu-user-email').textContent = user.email;

      // Logout
      document.getElementById('menu-logout-btn').addEventListener('click', () => {
        Auth.logout();
      });

      // Alternar tema no menu
      const menuThemeBtn = document.getElementById('menu-theme-btn');
      if (menuThemeBtn) {
        menuThemeBtn.addEventListener('click', () => {
          const isDark = document.documentElement.classList.contains('dark');
          if (isDark) {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
          } else {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
          }
        });
      }

      // Função para buscar e exibir agendamentos do usuário
      async function carregarMeusAgendamentos() {
        const container = document.getElementById('agendamentos-container');
        container.innerHTML = `<p class="text-center text-gray-600 dark:text-gray-400">Carregando agendamentos...</p>`;

        try {
          // Busca todas as reservas aprovadas (backend devolve apenas as com status: 'approved')
          const token = Auth.getToken(); // pega do localStorage
          const res = await fetch('https://coordena-backend.onrender.com/api/reservations', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          if (!res.ok) throw new Error('Falha ao buscar agendamentos');
          const todasReservas = await res.json();

          // Filtra apenas as reservas deste usuário (responsible === user.name)
          const minhasReservas = todasReservas.filter(r => r.responsible === user.name);

          if (minhasReservas.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-600 dark:text-gray-400">Você não possui agendamentos aprovados.</p>`;
            return;
          }

          // Monta cards para cada reserva
          const html = minhasReservas.map(r => {
            const recursoNome = r.sala ? r.sala : r.resource;
            const dataBR = new Date(r.date).toLocaleDateString('pt-BR');
            const statusCapitalizado = r.status.charAt(0).toUpperCase() + r.status.slice(1);
            return `
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col md:flex-row md:justify-between">
                <div class="space-y-1">
                  <p><span class="font-semibold">Data:</span> ${dataBR}</p>
                  <p><span class="font-semibold">Horário:</span> ${r.start} – ${r.end}</p>
                  <p><span class="font-semibold">Recurso:</span> ${recursoNome}</p>
                  <p><span class="font-semibold">Tipo:</span> ${r.type}</p>
                  <p><span class="font-semibold">Curso:</span> ${r.department}</p>
                  <p><span class="font-semibold">Matéria:</span> ${r.materia || '—'}</p>
                </div>
                <div class="mt-4 md:mt-0 md:text-right space-y-1">
                  <p>
                    <span class="font-semibold">Status:</span>
                    <span class="${r.status === 'approved' ? 'text-green-500' : 'text-yellow-500'}">
                      ${statusCapitalizado}
                    </span>
                  </p>
                  ${r.status === 'pending'
                    ? `<button onclick="cancelarReserva('${r._id}')"
                              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                         Cancelar
                       </button>`
                    : ``}
                </div>
              </div>
            `;
          }).join('');

          container.innerHTML = html;
        } catch (err) {
          console.error(err);
          container.innerHTML = `<p class="text-center text-red-500">Não foi possível carregar seus agendamentos.</p>`;
        }
      }

      // Função para cancelar reserva pendente
      window.cancelarReserva = async (id) => {
        if (!confirm('Deseja mesmo cancelar esta reserva pendente?')) return;
        try {
          const token = Auth.getToken();
          const res = await fetch(`https://coordena-backend.onrender.com/api/reservations/${id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          if (!res.ok) throw new Error('Falha ao cancelar reserva');
          // Recarrega lista após cancelar
          carregarMeusAgendamentos();
        } catch (err) {
          alert('Erro ao cancelar reserva: ' + err.message);
        }
      };

      // Carrega os agendamentos assim que a página estiver pronta
      carregarMeusAgendamentos();
    })();
  </script>
</body>
</html>
