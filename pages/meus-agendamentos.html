<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meus Agendamentos</title>

  <!-- Tailwind (opcional) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script>
    // Aplica imediatamente o tema salvo (evita flash)
    const _theme = localStorage.getItem('theme') || 'light';
    document.documentElement.classList.remove('light');
    if (_theme === 'dark') document.documentElement.classList.add('dark');
  </script>

  <!-- Auth library -->
  <script src="../assets/js/auth.js"></script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-500">

  <!-- Proteção de rota: se não estiver logado → redireciona p/ login -->
  <script>
    const user = Auth.getCurrentUser();
    if (!user) {
      window.location.href = '../pages/login.html';
    }
  </script>

  <!-- Header simples -->
  <header class="bg-blue-600 text-white py-4">
    <div class="container mx-auto flex justify-between items-center px-4">
      <h1 class="text-2xl font-semibold">Meus Agendamentos</h1>
      <button id="btn-voltar" class="px-3 py-1 bg-blue-400 rounded hover:bg-blue-500">
        ← Voltar ao Calendário
      </button>
    </div>
  </header>

  <!-- Conteúdo -->
  <main class="container mx-auto mt-8 px-4 space-y-6">

    <!-- Lista de Reservas do Usuário -->
    <section id="lista-meus-agendamentos" class="space-y-4">
      <!-- Aqui o JS vai injetar cada cartão de reserva -->
      <p class="text-center text-gray-500">Carregando seus agendamentos...</p>
    </section>

  </main>

  <footer class="text-center text-sm text-gray-600 dark:text-gray-400 py-6">
    Copyright© 2025 – Nexus Devsystem – Todos os direitos reservados.
  </footer>

  <script>
    (function() {
      // 1) Elementos
      const listaContainer = document.getElementById('lista-meus-agendamentos');
      const btnVoltar = document.getElementById('btn-voltar');

      // 2) API Base
      const API_BASE = window.location.hostname.includes('localhost')
        ? 'http://localhost:10000/api'
        : 'https://coordena-backend.onrender.com/api';

      // 3) Pega token do usuário
      const token = Auth.getToken(); // chave “token” salva no localStorage

      // 4) Função para buscar “Meus Agendamentos”
      async function carregarMeusAgendamentos() {
        listaContainer.innerHTML = '<p class="text-center text-gray-500">Carregando seus agendamentos...</p>';

        try {
          const res = await fetch(`${API_BASE}/reservations/me`, {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const dados = await res.json();

          if (!dados.length) {
            listaContainer.innerHTML = `
              <div class="text-center py-8 text-gray-500">
                <p>Você ainda não fez nenhum agendamento.</p>
              </div>`;
            return;
          }

          // 5) Renderiza cada agendamento
          listaContainer.innerHTML = '';
          dados.forEach(reserva => {
            const { _id, date, start, end, resource, sala, type, department, materia, status } = reserva;

            // Traduz status para exibição amigável e cor
            let corStatus = '';
            let textoStatus = '';
            switch(status) {
              case 'pending':
                corStatus = 'text-yellow-500'; textoStatus = 'Pendente';
                break;
              case 'approved':
                corStatus = 'text-blue-500'; textoStatus = 'Aprovado';
                break;
              case 'completed':
                corStatus = 'text-green-500'; textoStatus = 'Concluído';
                break;
              case 'canceled':
                corStatus = 'text-red-500'; textoStatus = 'Cancelado';
                break;
              default:
                corStatus = 'text-gray-500'; textoStatus = status;
            }

            // Se já estiver “completed” ou “canceled”, não mostramos botões de ação
            const showBtns = (status === 'pending' || status === 'approved');

            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2';

            card.innerHTML = `
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-sm text-gray-400 dark:text-gray-500">Data: <strong>${new Date(date).toLocaleDateString('pt-BR')}</strong></p>
                  <p class="text-sm text-gray-400 dark:text-gray-500">Horário: <strong>${start} – ${end}</strong></p>
                </div>
                <p class="font-semibold ${corStatus}">${textoStatus}</p>
              </div>
              <p class="text-sm"><strong>Recurso:</strong> ${resource} ${sala ? `– ${sala}` : ''}</p>
              <p class="text-sm"><strong>Tipo:</strong> ${type}</p>
              <p class="text-sm"><strong>Curso:</strong> ${department}</p>
              <p class="text-sm"><strong>Matéria:</strong> ${materia || '—'}</p>
              ${showBtns
                ? `<div class="flex gap-2 mt-3">
                    <button data-id="${_id}" data-acao="complete" class="btn-concluir px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded">
                      Concluir Atividade
                    </button>
                    <button data-id="${_id}" data-acao="cancel" class="btn-cancelar px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded">
                      Cancelar Reserva
                    </button>
                  </div>`
                : ''
              }
            `;
            listaContainer.appendChild(card);
          });

          // 6) Vincula os eventos dos botões (após inserirmos tudo)
          document.querySelectorAll('.btn-concluir').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              await atualizarStatus(id, 'completed');
            });
          });
          document.querySelectorAll('.btn-cancelar').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              await atualizarStatus(id, 'canceled');
            });
          });

        } catch (err) {
          console.error('Erro ao carregar meus agendamentos:', err);
          listaContainer.innerHTML = `
            <div class="text-center py-8 text-red-500">
              <p>Não foi possível carregar seus agendamentos.</p>
            </div>`;
        }
      }

      // 7) Função para chamar PUT /api/reservations/:id e atualizar status
      async function atualizarStatus(id, novoStatus) {
        if (!confirm(`Deseja realmente marcar como “${novoStatus === 'completed' ? 'Concluído' : 'Cancelado'}”?`)) {
          return;
        }
        try {
          const res = await fetch(`${API_BASE}/reservations/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ status: novoStatus })
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          // Após atualização de status → recarrega a lista
          carregarMeusAgendamentos();
        } catch (err) {
          console.error('Erro ao atualizar status:', err);
          alert('Não foi possível atualizar o status. Tente novamente.');
        }
      }

      // 8) “Voltar ao Calendário”
      btnVoltar.addEventListener('click', () => {
        window.location.href = 'agendamento.html'; // ou o caminho correto p/ a página de calendário
      });

      // 9) Na carga inicial da página, busca os agendamentos
      carregarMeusAgendamentos();
    })();
  </script>
</body>
</html>
