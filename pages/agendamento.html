<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Agendamento de Recursos</title>

  <!-- Favicon -->
  <link rel="icon" href="../assets/img/logo.png" type="image/png" />

  <!-- Tailwind + Dark Mode -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>

  <!-- Pre-apply theme -->
  <script>
    const _theme = localStorage.getItem('theme') || 'light';
    document.documentElement.classList.toggle('dark', _theme === 'dark');
  </script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- Auth library -->
  <script src="../assets/js/auth.js"></script>

  <style>
    /* ===========
       Off-canvas
       =========== */
    #side-menu {
      position: fixed; top: 0; right: 0;
      width: 16rem; height: 100vh;
      background: white; box-shadow: -2px 0 8px rgba(0,0,0,.1);
      transform: translateX(100%); transition: transform .5s cubic-bezier(.2,0,.2,1);
      z-index: 60; display: flex; flex-direction: column;
    }
    #side-menu.show { transform: translateX(0); }
    .dark #side-menu { background: #1F2937; color: #D1D5DB; box-shadow: -2px 0 8px rgba(0,0,0,.4); }

    /* Header do menu */
    #side-menu .menu-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem; border-bottom: 1px solid rgba(229,231,235);
    }
    .dark #side-menu .menu-header { border-color: rgba(55,65,81); }

    /* Nav links */
    #side-menu nav a {
      display: block; padding: .75rem 1rem;
      color: inherit; text-decoration: none;
      border-bottom: 1px solid rgba(229,231,235);
    }
    #side-menu nav a:hover { background: rgba(0,0,0,.05); }
    .dark #side-menu nav a { border-color: rgba(55,65,81); }
    .dark #side-menu nav a:hover { background: rgba(255,255,255,.1); }

    /* Bot√µes dentro do menu */
    .menu-header button {
      width: 2rem; height: 2rem;
      display: flex; align-items: center; justify-content: center;
      border: none; background: transparent; cursor: pointer;
      color: inherit; font-size: 1.25rem;
      transition: color .2s;
    }
    .menu-header button:hover { color: #3B82F6; }

    /* Toggle externo */
    #menu-toggle {
      position: fixed; top: 1rem; right: 1rem;
      width: 2.5rem; height: 2.5rem;
      background: #E5E7EB; border-radius: .5rem;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,.1);
      z-index: 65;
    }
    .dark #menu-toggle { background: #374151; }

    /* Mobile scroll lock */
    @media (max-width: 768px) {
      html, body { height: 100vh; overflow: hidden; }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

  <script>
    // Protege esta p√°gina: redireciona se n√£o autenticado
    const user = Auth.getCurrentUser();
    if (!user) window.location.href = '../login.html';
    if (user.role === 'student') {
      document.addEventListener('DOMContentLoaded', () => {
        ['open-form-modal','modal-edit','modal-cancel'].forEach(id=>{
          document.getElementById(id)?.classList.add('hidden');
        });
      });
    }
  </script>

  <!-- Bot√£o de abrir menu -->
  <button id="menu-toggle" aria-label="Abrir menu">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
  </button>

  <!-- Off-canvas menu -->
  <div id="side-menu">
    <div class="menu-header">
      <span class="font-semibold">Menu</span>
      <div class="flex items-center space-x-2">
        <!-- Dark mode toggle inside do menu -->
        <button id="theme-toggle" title="Alternar tema">üåì</button>
        <button id="menu-close" title="Fechar">√ó</button>
      </div>
    </div>
    <nav class="flex-1 overflow-auto">
      <a href="#" id="menu-notifications">Notifica√ß√µes</a>
      <a href="#" id="menu-profile">Perfil</a>
      <a href="#" id="menu-logout">Sair</a>
    </nav>
  </div>

  <!-- Conte√∫do principal -->
  <main class="pt-24 pb-8 mx-auto max-w-full px-4 space-y-8">
    <h1 class="text-3xl font-semibold text-center">Agendamento de Recursos</h1>
    <div class="flex justify-center">
      <button id="open-form-modal" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-md transform hover:scale-105 transition">
        Novo Agendamento
      </button>
    </div>
    <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 md:p-6 transition-colors duration-300">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Calend√°rio de Reservas</h2>
      <div id="calendar" class="w-full h-[600px]"></div>
    </section>
  </main>

  <!-- Modal de Formul√°rio -->
  <div id="form-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30">
    <div class="bg-white dark:bg-gray-800 relative w-full max-w-lg max-h-full rounded-xl overflow-auto p-6">
      <button id="form-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white z-20">‚úï</button>
      <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Novo Agendamento</h3>
      <form id="agendamento-form" class="space-y-4">
        <!-- campos de data/hora/recurso/tipo/sala/respons√°vel/curso/mat√©ria/status/descri√ß√£o -->
        <div><label for="data" class="block text-sm text-gray-700 dark:text-gray-300">Data</label><input type="date" id="data" required class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"></div>
        <div class="grid grid-cols-2 gap-4">
          <div><label for="start" class="block text-sm text-gray-700 dark:text-gray-300">In√≠cio</label><input type="time" id="start" required min="07:00" max="22:00" step="60" class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"></div>
          <div><label for="end" class="block text-sm text-gray-700 dark:text-gray-300">T√©rmino</label><input type="time" id="end" required min="07:00" max="22:00" step="60" class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"></div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div><label for="recurso" class="block text-sm text-gray-700 dark:text-gray-300">Recurso</label><select id="recurso" required class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"><option value="">Selecione...</option><option>Laborat√≥rio</option><option>Sala de Aula</option><option>Audit√≥rio</option></select></div>
          <div><label for="tipo-evento" class="block text-sm text-gray-700 dark:text-gray-300">Tipo de Evento</label><select id="tipo-evento" required class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"><option value="">Selecione...</option><option>Aula</option><option>Reuni√£o</option><option>Palestra</option><option>Workshop</option></select></div>
        </div>
        <div id="sala-container" class="hidden"><label for="sala" class="block text-sm text-gray-700 dark:text-gray-300">Qual Sala?</label><select id="sala" class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"><option value="">Selecione...</option></select></div>
        <div><label for="responsavel" class="block text-sm text-gray-700 dark:text-gray-300">Respons√°vel</label><input type="text" id="responsavel" placeholder="Nome do professor" required class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div><label for="departamento" class="block text-sm text-gray-700 dark:text-gray-300">Curso</label><input type="text" id="departamento" placeholder="Ex: Engenharia de Computa√ß√£o" required class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"></div>
          <div><label for="curso" class="block text-sm text-gray-700 dark:text-gray-300">Mat√©ria</label><select id="curso" required class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"><option value="">Selecione a mat√©ria...</option></select></div>
        </div>
        <div><label for="status" class="block text-sm text-gray-700 dark:text-gray-300">Status da Reserva</label><select id="status" required class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"><option value="Pendente">Pendente</option><option value="Aprovado">Aprovado</option><option value="Rejeitado">Rejeitado</option></select></div>
        <div><label for="descricao" class="block text-sm text-gray-700 dark:text-gray-300">Descri√ß√£o (opcional)</label><textarea id="descricao" rows="3" class="w-full mt-1 px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"></textarea></div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-md py-2 mt-2 transform hover:scale-105 transition">Confirmar</button>
      </form>
    </div>
  </div>

  <!-- Modal de Detalhes -->
  <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-11/12 max-w-md relative">
      <button id="modal-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">‚úï</button>
      <h3 class="text-xl font-semibold mb-2">Detalhes da Reserva</h3>
      <p id="modal-date"     class="mb-1 text-gray-700 dark:text-gray-300"></p>
      <p id="modal-resource" class="mb-1 text-gray-700 dark:text-gray-300"></p>
      <p id="modal-type"     class="mb-1 text-gray-700 dark:text-gray-300"></p>
      <p id="modal-resp"     class="mb-1 text-gray-700 dark:text-gray-300"></p>
      <p id="modal-dept"     class="mb-1 text-gray-700 dark:text-gray-300"></p>
      <p id="modal-status"   class="mb-1 text-gray-700 dark:text-gray-300"></p>
      <p id="modal-desc"     class="mb-4 text-gray-700 dark:text-gray-300"></p>
      <div class="flex justify-end space-x-4">
        <button id="modal-edit"   class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded">Editar</button>
        <button id="modal-cancel" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">Cancelar reserva</button>
      </div>
    </div>
  </div>

  <footer class="text-center text-sm text-gray-600 dark:text-gray-400 pb-6">
    Desenvolvido por Nexus ¬∑ 2025 ‚Ä¢ Todos os direitos reservados.
  </footer>

  <!-- Menu & Darkmode logic -->
  <script>
    // Abre/fecha menu
    document.getElementById('menu-toggle').addEventListener('click', () => {
      document.getElementById('side-menu').classList.add('show');
    });
    document.getElementById('menu-close').addEventListener('click', () => {
      document.getElementById('side-menu').classList.remove('show');
    });
    // Linkagem para notifica√ß√µes/perfil/logout
    document.getElementById('menu-notifications').addEventListener('click', () => {
      document.getElementById('notification-btn')?.click();
      document.getElementById('side-menu').classList.remove('show');
    });
    document.getElementById('menu-profile').addEventListener('click', () => {
      document.getElementById('profile-btn')?.click();
      document.getElementById('side-menu').classList.remove('show');
    });
    document.getElementById('menu-logout').addEventListener('click', () => {
      document.getElementById('logout-link')?.click();
    });
    // Toggle tema j√° vinculado ao bot√£o interno
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const root = document.documentElement;
      const mode = root.classList.contains('dark') ? 'light' : 'dark';
      root.classList.toggle('dark', mode === 'dark');
      localStorage.setItem('theme', mode);
    });
  </script>

  <!-- =============================
       Aqui come√ßam SEUS M√ìDULOS JS
       (copie exatamente do seu main.js)
       ============================= -->
  <script>
  // UTILIDADES
  function onReady(fn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }

  // M√ìDULO DE TEMA (Dark/Light) ‚Äì j√° inicializado no menu

  // M√ìDULO DE API
  const Api = (() => {
    const BASE = window.location.hostname.includes('localhost')
      ? 'http://localhost:10000/api/reservas'
      : 'https://coordena-backend.onrender.com/api/reservas';
    function authHeaders(isJson = false) {
      const headers = { 'Authorization': `Bearer ${Auth.getToken()||''}` };
      if (isJson) headers['Content-Type'] = 'application/json';
      return headers;
    }
    async function fetchEvents() {
      const res = await fetch(BASE, { headers: authHeaders(false) });
      if (!res.ok) throw new Error(`Falha ao buscar reservas: ${res.status}`);
      return res.json();
    }
    async function createEvent(data) {
      const res = await fetch(BASE, {
        method: 'POST', headers: authHeaders(true), body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('Falha ao criar reserva');
      return res.json();
    }
    async function updateEvent(id,data){
      const res = await fetch(`${BASE}/${id}`,{
        method:'PUT',headers:authHeaders(true),body:JSON.stringify(data)
      });
      if(!res.ok) throw new Error('Falha ao atualizar reserva');
      return res.json();
    }
    async function deleteEvent(id){
      const res = await fetch(`${BASE}/${id}`,{
        method:'DELETE',headers:authHeaders(false)
      });
      if(!res.ok) throw new Error('Falha ao excluir reserva');
    }
    return { fetchEvents, createEvent, updateEvent, deleteEvent };
  })();

  // M√ìDULO CALEND√ÅRIO
  const CalendarModule = (() => {
    let calendar, events = [];
    function init(raw, onDateClick, onEventClick){
      events = raw;
      const el = document.getElementById('calendar');
      if(!el) return console.error('#calendar n√£o encontrado');
      const isMobile = window.innerWidth < 640;
      calendar = new FullCalendar.Calendar(el,{
        locale:'pt-br',
        initialView: isMobile?'listWeek':'dayGridMonth',
        headerToolbar:{
          left: isMobile?'prev,next':'prev,next today',
          center:'title',
          right: isMobile?'':'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events.map(e=>({
          id:e._id,
          title:`${e.title} (${e.time})`,
          start:`${e.date}T${e.start}`,
          end:`${e.date}T${e.end}`
        })),
        dateClick:onDateClick,
        eventClick:onEventClick,
        height:el.clientHeight,
        allDaySlot:false
      });
      calendar.render();
      window.addEventListener('resize',()=>{
        const nowMobile = window.innerWidth<640;
        calendar.changeView(nowMobile?'listWeek':'dayGridMonth');
        calendar.setOption('headerToolbar',{
          left: nowMobile?'prev,next':'prev,next today',
          center:'title',
          right: nowMobile?'':'dayGridMonth,timeGridWeek,timeGridDay'
        });
      });
    }
    function add(ev){ calendar.addEvent({ id:ev._id, title:`${ev.title} (${ev.time})`, start:`${ev.date}T${ev.start}`, end:`${ev.date}T${ev.end}` }); events.push(ev); }
    function update(id,ev){ events=events.map(e=>e._id===id?ev:e); const obj=calendar.getEventById(id); if(obj){ obj.setProp('title',`${ev.title} (${ev.time})`); obj.setStart(`${ev.date}T${ev.start}`); obj.setEnd(`${ev.date}T${ev.end}`); } }
    function remove(id){ events=events.filter(e=>e._id!==id); calendar.getEventById(id)?.remove(); }
    return { init, add, update, remove, getEvents:()=>events };
  })();

  // M√ìDULO FORMUL√ÅRIO
  const FormModule = (() => {
    let currentId=null; const selectors={};
    function cacheSelectors(){
      selectors.modal    =document.getElementById('form-modal');
      selectors.form     =document.getElementById('agendamento-form');
      selectors.btnOpen  =document.getElementById('open-form-modal');
      selectors.btnClose =document.getElementById('form-close');
      selectors.fields   ={
        data: document.getElementById('data'),
        start: document.getElementById('start'),
        end: document.getElementById('end'),
        recurso: document.getElementById('recurso'),
        salaContainer: document.getElementById('sala-container'),
        sala: document.getElementById('sala'),
        type: document.getElementById('tipo-evento'),
        resp: document.getElementById('responsavel'),
        dept: document.getElementById('departamento'),
        materia: document.getElementById('curso'),
        status: document.getElementById('status'),
        desc: document.getElementById('descricao')
      };
    }
    function open(id=null,evData=null){
      currentId=id; selectors.form.reset(); selectors.fields.salaContainer.classList.add('hidden');
      if(evData){
        selectors.fields.data.value    =evData.date;
        selectors.fields.start.value   =evData.start;
        selectors.fields.end.value     =evData.end;
        selectors.fields.recurso.value =evData.resource;
        selectors.fields.recurso.dispatchEvent(new Event('change'));
        selectors.fields.sala.value    =evData.sala||'';
        selectors.fields.type.value    =evData.type;
        selectors.fields.resp.value    =evData.responsible;
        selectors.fields.dept.value    =evData.department;
        selectors.fields.status.value  =evData.status;
        selectors.fields.desc.value    =evData.description;
      }
      if(!currentId){
        const u=Auth.getCurrentUser();
        if(u?.name){ selectors.fields.resp.value=u.name; selectors.fields.resp.setAttribute('readonly','readonly'); }
      }
      selectors.modal.classList.remove('hidden');
    }
    function close(){ selectors.modal.classList.add('hidden'); }
    function handleSubmit(e){
      e.preventDefault();
      const f=selectors.fields;
      const payload={
        date: f.data.value,
        start: f.start.value,
        end: f.end.value,
        resource: f.recurso.value,
        sala: f.salaContainer.classList.contains('hidden')?'':f.sala.value,
        type: f.type.value,
        responsible: f.resp.value,
        department: f.dept.value,
        status: f.status.value,
        description: f.desc.value,
        time: `${f.start.value}-${f.end.value}`,
        title: f.salaContainer.classList.contains('hidden')?f.type.value:`${f.type.value} - ${f.sala.value}`
      };
      (async()=>{
        try{
          let saved;
          if(currentId){ saved=await Api.updateEvent(currentId,payload); CalendarModule.update(currentId,saved); }
          else         { saved=await Api.createEvent(payload); CalendarModule.add(saved); }
          close();
        }catch(err){ alert(err.message); }
      })();
    }
    function init(){
      cacheSelectors();
      selectors.btnOpen?.addEventListener('click',()=>open());
      selectors.btnClose?.addEventListener('click',close);
      selectors.form?.addEventListener('submit',handleSubmit);
      // salas
      const salaOpts={ 'Laborat√≥rio':['Lab401','Lab402','Lab403'], 'Sala de Aula':['Sala101','Sala102','Sala103'], 'Audit√≥rio':['Audit√≥rio A','Audit√≥rio B'] };
      selectors.fields.recurso?.addEventListener('change',()=>{
        const tipo=selectors.fields.recurso.value;
        if(salaOpts[tipo]){
          selectors.fields.salaContainer.classList.remove('hidden');
          selectors.fields.sala.innerHTML='<option value="">Selecione...</option>'+salaOpts[tipo].map(s=>`<option>${s}</option>`).join('');
        } else selectors.fields.salaContainer.classList.add('hidden');
      });
      // cursos √ó mat√©rias
      const courseMap={
        'Engenharia de Computa√ß√£o':[
          'ARA0003 - PRINC√çPIOS DE GEST√ÉO','ARA0017 - INTRODUCAO A PROGRAMA√á√ÉO DE COMPUTADORES','ARA0039 - ARQUITETURA DE COMPUTADORES',
          'ARA0045 - ENGENHARIA, SOCIEDADE E SUSTENTABILIDADE','ARA0015 - C√ÅLCULO DIFERENCIAL E INTEGRAL','ARA0020 - GEOMETRIA ANAL√çTICA E √ÅLGEBRA LINEAR',
          'ARA0038 - REPRESENTA√á√ÉO GR√ÅFICA PARA PROJETO','ARA0048 - F√çSICA TE√ìRICA EXPERIMENTAL - MEC√ÇNICA','ARA1386 - SISTEMAS OPERACIONAIS',
          'ARA0002 - PENSAMENTO COMPUTACIONAL','ARA0014 - AN√ÅLISE DE DADOS','ARA0018 - C√ÅLCULO DE M√öLTIPLAS VARI√ÅVEIS',
          'ARA0044 - ELETRICIDADE E MAGNETISMO','ARA0047 - F√çSICA TE√ìRICA EXPER. - FLUIDOS, CALOR, OSCILA√á√ïES','ARA1398 - MEC√ÇNICA DOS S√ìLIDOS',
          'ARA0029 - ELETRICIDADE APLICADA','ARA0030 - EQUA√á√ïES DIFERENCIAIS','ARA0046 - FEN√îMENOS DE TRANSPORTE',
          'ARA0056 - QU√çMICA TECNOL√ìGICA','ARA2042 - SISTEMAS DIGITAIS','ARA0079 - COMUNICA√á√ïES DE DADOS E REDES DE COMPUTADORES',
          'ARA0083 - ELETR√îNICA ANAL√ìGICA','ARA0125 - CONTROLADORES L√ìGICOS PROGRAM√ÅVEIS','ARA1943 - MODELAGEM MATEM√ÅTICA',
          'ARA0040 - BANCO DE DADOS','ARA0098 - ESTRUTURA DE DADOS','COMPILADORES',
          'ARA2545 - SISTEMAS DISTRIBU√çDOS E COMPUTA√á√ÉO PARALELA','ARA0095 - DESENVOLVIMENTO R√ÅPIDO DE APLICA√á√ïES EM PYTHON','ARA0141 - INSTRUMENTA√á√ÉO INDUSTRIAL',
          'ARA0363 - PROGRAMA√á√ÉO DE SOFTWARE B√ÅSICO EM C','ARA2086 - ALGORITMOS EM GRAFOS','ARA0301 - PROGRAMA√á√ÉO DE MICROCONTROLADORES',
          'ARA0309 - LINGUAGENS FORMAIS E AUT√îMATOS','ARA1879 - AUTOMA√á√ÉO INDUSTRIAL','ARA0085 - INTELIG√äNCIA ARTIFICIAL',
          'ARA0115 - SISTEMAS EMBARCADOS','ARA1191 - SUP. DE EST√ÅGIO E PR√â-PROJETO EM ENG. DE COM.','ARA1518 - ALGORITMOS DE PROCESSAMENTO DE IMAGEM',
          'ARA0026 - T√ìPICOS EM LIBRAS: SURDEZ E INCLUS√ÉO','ARA0154 - PROCESSOS INDUSTRIAIS E ROB√ìTICA','ARA0869 - INOVA√á√ÉO, EMPREENDE. E PROJETO FINAL - ENG DE COMP',
          'ARA2074 - SEGURAN√áA CIBERN√âTICA'
        ]
      };
      selectors.fields.dept?.addEventListener('change',()=>{
        const c=selectors.fields.dept.value;
        const lista=courseMap[c]||[];
        const sel=selectors.fields.materia;
        sel.innerHTML = lista.length
          ? '<option value="">Selecione a mat√©ria...</option>'+lista.map(m=>`<option value="${m}">${m}</option>`).join('')
          : '<option value="">Digite primeiro um curso v√°lido</option>';
      });
    }
    return { init, open };
  })();

  // M√ìDULO DETALHES
  const DetailModule = (() => {
    let currentId=null; const selectors={};
    function cacheSelectors(){
      selectors.modal     =document.getElementById('event-modal');
      selectors.btnClose  =document.getElementById('modal-close');
      selectors.btnEdit   =document.getElementById('modal-edit');
      selectors.btnDelete =document.getElementById('modal-cancel');
      selectors.fields    ={
        date: document.getElementById('modal-date'),
        resource: document.getElementById('modal-resource'),
        type: document.getElementById('modal-type'),
        resp: document.getElementById('modal-resp'),
        dept: document.getElementById('modal-dept'),
        status: document.getElementById('modal-status'),
        desc: document.getElementById('modal-desc')
      };
    }
    function open(ev){
      currentId=ev._id;
      const f=selectors.fields;
      f.date.textContent     =`Data: ${ev.date} (${ev.time})`;
      f.resource.textContent =`Recurso: ${ev.resource}`;
      f.type.textContent     =`Evento: ${ev.type}`;
      f.resp.textContent     =`Respons√°vel: ${ev.responsible}`;
      f.dept.textContent     =`Departamento: ${ev.department}`;
      f.status.textContent   =`Status: ${ev.status}`;
      f.desc.textContent     =ev.description||'Sem descri√ß√£o';
      selectors.modal.classList.remove('hidden');
    }
    function close(){ selectors.modal.classList.add('hidden'); }
    function init(){
      cacheSelectors();
      selectors.btnClose?.addEventListener('click',close);
      selectors.btnEdit?.addEventListener('click',()=>{
        if(!currentId)return;
        const ev=CalendarModule.getEvents().find(e=>e._id===currentId);
        if(ev) FormModule.open(currentId,ev);
        close();
      });
      selectors.btnDelete?.addEventListener('click',async()=>{
        if(!currentId)return;
        try{ await Api.deleteEvent(currentId); CalendarModule.remove(currentId); close(); }
        catch(err){ alert(err.message); }
      });
    }
    return { init, open };
  })();

  // Inicializa√ß√£o
  onReady(async()=>{
    FormModule.init();
    DetailModule.init();
    let data=[];
    try{ data=await Api.fetchEvents(); } catch(err){ console.warn('Falha ao buscar reservas',err); }
    CalendarModule.init(
      data,
      info=>FormModule.open(null,{
        date:info.dateStr,start:'00:00',end:'00:00',
        resource:'',sala:'',type:'',responsible:'',
        department:'',status:'',description:'',time:''
      }),
      info=>{ const ev=CalendarModule.getEvents().find(e=>e._id===info.event.id); if(ev)DetailModule.open(ev); }
    );
  });
  </script>
</body>
</html>
