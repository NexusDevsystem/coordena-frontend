<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Agendamento de Recursos</title>

  <!-- Favicon -->
  <link rel="icon" href="../assets/img/logo.png" type="image/png" />

  <!-- PWA / full-screen on mobile -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2563EB">
  <link rel="manifest" href="../manifest.json">

  <!-- Tailwind + Dark Mode -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>

  <!-- Aplica imediatamente o tema salvo (evita flash) -->
  <script>
    const _theme = localStorage.getItem('theme') || 'light';
    document.documentElement.classList.remove('light');
    if (_theme === 'dark') document.documentElement.classList.add('dark');
  </script>

  <link rel="stylesheet" href="../assets/css/styles.css" />

  <!-- FullCalendar CSS & JS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <style>
    /* ================================================
       Background & Scroll Lock
       ================================================ */
    body {
      background-image: url("../assets/img/background.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .dark body {
      background-image: url("../assets/img/backgrounddark.png");
    }
    @media (max-width: 768px) {
      html, body { height: 100vh; overflow: hidden; }
    }
    @media (min-width: 769px) {
      body { overflow-y: auto; }
    }

    /* ================================================
       Off-canvas Menu (direita → centro)
       ================================================ */
    #side-menu {
      position: fixed;
      top: 0; right: 0;
      height: 100vh;
      width: 50vw; max-width: 480px;
      transform: translateX(100%);
      background: rgba(22,21,31,0.95);
      box-shadow: -2px 0 12px rgba(0,0,0,0.5);
      transition: transform 0.35s cubic-bezier(0.22,1,0.36,1);
      z-index: 50;
      display: flex; flex-direction: column;
    }
    #side-menu.show {
      transform: translateX(0);
    }

    /* cabeçalho com abas */
    #side-menu .menu-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 1.5rem;
    }
    #side-menu .menu-header ul {
      display: flex; gap: 1rem;
    }
    #side-menu .menu-header ul li a {
      display: block;
      padding: 0.5rem 1.5rem;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 1.125rem;
      line-height: 1.5rem;
      text-decoration: none;
      transition: background 0.2s, color 0.2s;
    }
    #side-menu .menu-header ul li a.active {
      background: white; color: black;
    }
    #side-menu .menu-header ul li a:not(.active) {
      color: white;
    }
    #side-menu .menu-header ul li a:not(.active):hover {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    /* botão fechar */
    #side-menu .menu-header button {
      background: rgba(255,255,255,0.1);
      width: 2.5rem; height: 2.5rem;
      border-radius: 9999px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    #side-menu .menu-header button:hover {
      background: rgba(255,255,255,0.2);
    }

    /* conteúdo interno */
    #side-menu .menu-content {
      flex: 1; overflow-y: auto;
      padding: 1rem 1.5rem;
    }
    #side-menu .menu-content p {
      font-size: 1.25rem;
      line-height: 1.75rem;
      font-weight: 600;
      color: white;
      margin-bottom: 0.75rem;
    }
  </style>

  <!-- Auth library -->
  <script src="../assets/js/auth.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-500">

  <script>
    // Proteção de rota
    const user = Auth.getCurrentUser();
    if (!user) window.location.href = '../login.html';
    if (user.role === 'student') {
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('open-form-modal')?.classList.add('hidden');
        document.getElementById('modal-edit')?.classList.add('hidden');
        document.getElementById('modal-cancel')?.classList.add('hidden');
      });
    }
  </script>

  <!-- Off-canvas Menu -->
  <div id="side-menu">
    <div class="menu-header">
      <ul>
        <li><a href="#" class="active">Pessoas</a></li>
        <li><a href="#">Lugares</a></li>
        <li><a href="#">Trailers</a></li>
        <li><a href="#">Downloads</a></li>
      </ul>
      <button id="menu-close" aria-label="Fechar menu">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="menu-content">
      <p>Jason Duval</p>
      <p>Lucia Caminos</p>
      <p>Cal Hampton</p>
      <p>Boobie Ike</p>
      <p>Dre'quan Priest</p>
      <p>Real Dimez</p>
      <p>Raul Bautista</p>
      <p>Brian Heder</p>
    </div>
  </div>

  <!-- Menu Toggle Rockstar Style (esquerda) -->
  <div class="fixed top-4 left-4 z-50">
    <button id="menu-toggle"
            class="w-12 h-12 border-2 border-gray-200 dark:border-gray-700 rounded-full
                   bg-gray-200 dark:bg-gray-800 flex flex-col items-center justify-center space-y-1
                   focus:outline-none transition duration-200">
      <span class="block w-6 h-1 bg-gray-800 dark:bg-gray-200 transition-transform duration-300"></span>
      <span class="block w-6 h-1 bg-gray-800 dark:bg-gray-200 transition-transform duration-300"></span>
    </button>
  </div>

  <!-- Quick Access -->
  <div class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 bg-opacity-60 backdrop-blur-md rounded-full p-2 flex space-x-4 z-40">
    <a href="../index.html" class="p-2 bg-gray-700 rounded-full hover:bg-gray-600 transform hover:scale-110 transition duration-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 12l9-9 9 9m-1 9h-4a2 2 0
                 01-2-2v-5H9v5a2 2 0
                 01-2 2H5"/>
      </svg>
    </a>
    <button class="p-2 bg-blue-500 rounded-full hover:scale-110 transform transition duration-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5
                 21h14a2 2 0 002-2V7a2 2 0
                 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
    </button>
  </div>

  <!-- Main content -->
  <main class="pt-24 pb-8 mx-auto max-w-full px-4 space-y-8">
    <h1 class="text-3xl font-semibold text-center">Agendamento de Recursos</h1>
    <div class="flex justify-center">
      <button id="open-form-modal"
              class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-md transform hover:scale-105 transition">
        Novo Agendamento
      </button>
    </div>
    <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 md:p-6 transition-colors duration-300">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">
        Calendário de Reservas
      </h2>
      <div id="calendar" class="w-full h-[600px]"></div>
    </section>
  </main>

  <!-- Modal de Form -->
  <div id="form-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30">
    <div class="bg-white dark:bg-gray-800 relative w-full max-w-lg max-h-full rounded-xl overflow-auto p-6">
      <button id="form-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white z-20">✕</button>
      <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Novo Agendamento</h3>
      <form id="agendamento-form" class="space-y-4">
        <!-- ... form fields permanecem inalterados ... -->
      </form>
    </div>
  </div>

  <!-- Modal de Detalhes -->
  <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20">
    <!-- ... permanece igual ... -->
  </div>

  <footer class="text-center text-sm text-gray-600 dark:text-gray-400 pb-6">
    Copyright© 2025 – Nexus Devsystem – Todos os direitos reservados.
  </footer>

  <!-- Todos os módulos JS inline -->
  <script>
  // ----------------------
  // UTILIDADES
  // ----------------------
  function onReady(fn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }

  // ----------------------
  // MÓDULO DE TEMA (Dark/Light)
  // ----------------------
  const ThemeToggle = (() => {
    const themeKey = 'theme';
    const root     = document.documentElement;
    function applyTheme(mode) {
      root.classList.toggle('dark', mode === 'dark');
      localStorage.setItem(themeKey, mode);
    }
    function init() {
      const saved = localStorage.getItem(themeKey) || 'light';
      applyTheme(saved);
      const btn = document.getElementById('menu-theme');
      if (btn) btn.addEventListener('click', () => {
        applyTheme(root.classList.contains('dark') ? 'light' : 'dark');
      });
    }
    return { init };
  })();

  // ----------------------
  // MÓDULO DE API
  // ----------------------
  const Api = (() => {
    const BASE = window.location.hostname.includes('localhost')
      ? 'http://localhost:10000/api/reservas'
      : 'https://coordena-backend.onrender.com/api/reservas';

    function authHeaders(isJson = false) {
      const headers = { 'Authorization': `Bearer ${Auth.getToken() || ''}` };
      if (isJson) headers['Content-Type'] = 'application/json';
      return headers;
    }

    async function fetchEvents() {
      const res = await fetch(BASE, { headers: authHeaders(false) });
      if (!res.ok) throw new Error(`Falha ao buscar reservas: ${res.status}`);
      return res.json();
    }
    async function createEvent(data) {
      const res = await fetch(BASE, {
        method: 'POST',
        headers: authHeaders(true),
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('Falha ao criar reserva');
      return res.json();
    }
    async function updateEvent(id, data) {
      const res = await fetch(`${BASE}/${id}`, {
        method: 'PUT',
        headers: authHeaders(true),
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('Falha ao atualizar reserva');
      return res.json();
    }
    async function deleteEvent(id) {
      const res = await fetch(`${BASE}/${id}`, {
        method: 'DELETE',
        headers: authHeaders(false)
      });
      if (!res.ok) throw new Error('Falha ao excluir reserva');
    }
    return { fetchEvents, createEvent, updateEvent, deleteEvent };
  })();

  // ----------------------
  // MÓDULO CALENDÁRIO (SUPORTE MOBILE)
  // ----------------------
  const CalendarModule = (() => {
    let calendar;
    let events = [];

    function init(rawEvents, onDateClick, onEventClick) {
      events = rawEvents;
      const el = document.getElementById('calendar');
      if (!el) return console.error('#calendar não encontrado');

      const isMobile = window.innerWidth < 640;
      calendar = new FullCalendar.Calendar(el, {
        locale: 'pt-br',
        initialView: isMobile ? 'listWeek' : 'dayGridMonth',
        headerToolbar: {
          left:   isMobile ? 'prev,next' : 'prev,next today',
          center: 'title',
          right:  isMobile ? '' : 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events.map(e => ({
          id:    e._id,
          title: `${e.title} (${e.time})`,
          start: `${e.date}T${e.start}`,
          end:   `${e.date}T${e.end}`
        })),
        dateClick:  async info => {
          onDateClick(info);
          // BLOQUEAR horários da grade para o LAB selecionado e Data clicada
          const lab = document.getElementById('recurso').value;
          const date = info.dateStr;
          if (lab) {
            const resp = await fetch(`/api/scheduled-blocks?lab=${encodeURIComponent(lab)}&date=${date}`);
            const blocks = await resp.json();
            // remove fontes anteriores de background
            window.calendar.getEventSources().forEach(src => {
              if (src.internalEventSource.def.rendering === 'background') src.remove();
            });
            // adiciona novos blocos
            window.calendar.addEventSource(blocks.map(b => ({
              start:     `${date}T${b.startTime}`,
              end:       `${date}T${b.endTime}`,
              rendering: 'background',
              color:     '#f87171',
              overlap:   false
            })));
          }
        },
        eventClick: onEventClick,
        height:     el.clientHeight,
        allDaySlot: false,
        selectAllow: selectInfo => {
          // impede seleção dentro de blocos de grade
          return !window.calendar.getEvents().some(ev =>
            ev.rendering === 'background' &&
            selectInfo.start < ev.end && selectInfo.end > ev.start
          );
        }
      });

      // expõe o calendário globalmente
      window.calendar = calendar;
      calendar.render();
      window.addEventListener('resize', () => {
        const nowMobile = window.innerWidth < 640;
        const newView   = nowMobile ? 'listWeek' : 'dayGridMonth';
        calendar.changeView(newView);
        calendar.setOption('headerToolbar', {
          left:   nowMobile ? 'prev,next' : 'prev,next today',
          center: 'title',
          right:  nowMobile ? '' : 'dayGridMonth,timeGridWeek,timeGridDay'
        });
      });
    }

    function add(ev) {
      calendar.addEvent({
        id:    ev._id,
        title: `${ev.title} (${ev.time})`,
        start: `${ev.date}T${ev.start}`,
        end:   `${ev.date}T${ev.end}`
      });
      events.push(ev);
    }

    function update(id, ev) {
      events = events.map(e => (e._id === id ? ev : e));
      const obj = calendar.getEventById(id);
      if (obj) {
        obj.setProp('title', `${ev.title} (${ev.time})`);
        obj.setStart(`${ev.date}T${ev.start}`);
        obj.setEnd(`${ev.date}T${ev.end}`);
      }
    }

    function remove(id) {
      events = events.filter(e => e._id !== id);
      calendar.getEventById(id)?.remove();
    }

    return { init, add, update, remove, getEvents: () => events };
  })();

  // ----------------------
  // MÓDULO FORMULÁRIO
  // ----------------------
  const FormModule = (() => {
    let currentId = null;
    const selectors = {};

    function cacheSelectors() {
      selectors.modal    = document.getElementById('form-modal');
      selectors.form     = document.getElementById('agendamento-form');
      selectors.btnOpen  = document.getElementById('open-form-modal');
      selectors.btnClose = document.getElementById('form-close');
      selectors.fields   = {
        data:          document.getElementById('data'),
        start:         document.getElementById('start'),
        end:           document.getElementById('end'),
        recurso:       document.getElementById('recurso'),
        salaContainer: document.getElementById('sala-container'),
        sala:          document.getElementById('sala'),
        type:          document.getElementById('tipo-evento'),
        resp:          document.getElementById('responsavel'),
        dept:          document.getElementById('departamento'),
        materia:       document.getElementById('curso'),
        status:        document.getElementById('status'),
        desc:          document.getElementById('descricao')
      };
    }

    function open(id = null, evData = null) { /* ... idêntico ... */ }
    function close() { /* ... idêntico ... */ }
    function handleSubmit(e) { /* ... idêntico ... */ }
    function init() { /* ... idêntico ... */ }

    return { init, open };
  })();

  // ----------------------
  // MÓDULO MODAL DETALHES
  // ----------------------
  const DetailModule = (() => { /* ... idêntico ... */ })();

  // ----------------------
  // INICIALIZAÇÃO PRINCIPAL
  // ----------------------
  onReady(async () => {
    ThemeToggle.init();
    FormModule.init();
    DetailModule.init();

    let data = [];
    try {
      data = await Api.fetchEvents();
    } catch (err) {
      console.warn('Falha ao buscar reservas, iniciando calendário vazio', err);
    }

    CalendarModule.init(
      data,
      info => FormModule.open(null, {
        date: info.dateStr, start: '00:00', end: '00:00',
        resource: '', sala: '', type: '',
        responsible: '', department: '',
        status: '', description: '', time: ''
      }),
      info => {
        const ev = CalendarModule.getEvents().find(e => e._id === info.event.id);
        if (ev) DetailModule.open(ev);
      }
    );

    // Toggle off-canvas
    const toggle = document.getElementById('menu-toggle');
    const menu   = document.getElementById('side-menu');
    toggle.addEventListener('click', () => {
      const open = menu.classList.toggle('show');
      const bars = toggle.querySelectorAll('span');
      document.body.classList.toggle('overflow-hidden', open);
      if (open) {
        bars[0].classList.add('rotate-45','translate-y-1');
        bars[1].classList.add('-rotate-45','-translate-y-1');
      } else {
        bars[0].classList.remove('rotate-45','translate-y-1');
        bars[1].classList.remove('-rotate-45','-translate-y-1');
      }
    });
    document.getElementById('menu-close').addEventListener('click', () => {
      menu.classList.remove('show');
      const bars = toggle.querySelectorAll('span');
      bars[0].classList.remove('rotate-45','translate-y-1');
      bars[1].classList.remove('-rotate-45','-translate-y-1');
      document.body.classList.remove('overflow-hidden');
    });
  });
  </script>
</body>
</html>
