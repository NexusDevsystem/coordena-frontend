<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Administração</title>

  <!-- Tailwind + Bootstrap CSS (ou apenas Bootstrap caso prefira) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script>
    // Aplica imediatamente o tema salvo (evita flash)
    const _theme = localStorage.getItem('theme') || 'light';
    document.documentElement.classList.remove('light');
    if (_theme === 'dark') document.documentElement.classList.add('dark');
  </script>

  <!-- Auth e Api já devem estar disponíveis -->
  <script src="../assets/js/auth.js"></script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="container-fluid p-0">

    <!-- Navbar ou Header do Admin -->
    <nav class="navbar bg-blue-600 text-white">
      <div class="container-fluid px-4">
        <span class="navbar-brand mb-0 h1">Painel de Administração</span>
      </div>
    </nav>

    <!-- Abas de navegação do Admin -->
    <ul class="nav nav-tabs mt-4 px-4" id="adminTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="tab-usuarios"
          data-bs-toggle="tab"
          data-bs-target="#pane-usuarios"
          type="button"
          role="tab"
          aria-controls="pane-usuarios"
          aria-selected="true"
        >
          Usuários Pendentes
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="tab-reservas-pendentes"
          data-bs-toggle="tab"
          data-bs-target="#pane-reservas-pendentes"
          type="button"
          role="tab"
          aria-controls="pane-reservas-pendentes"
          aria-selected="false"
        >
          Reservas Pendentes
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="tab-reservas-ativas"
          data-bs-toggle="tab"
          data-bs-target="#pane-reservas-ativas"
          type="button"
          role="tab"
          aria-controls="pane-reservas-ativas"
          aria-selected="false"
        >
          Reservas Ativas
        </button>
      </li>
      <!-- Nova Aba: Ocupação -->
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="tab-ocupacao"
          data-bs-toggle="tab"
          data-bs-target="#pane-ocupacao"
          type="button"
          role="tab"
          aria-controls="pane-ocupacao"
          aria-selected="false"
        >
          Ocupação
        </button>
      </li>
    </ul>

    <!-- Conteúdo das abas -->
    <div class="tab-content px-4 pt-4" id="adminTabContent">

      <!-- Pane Usuários Pendentes -->
      <div
        class="tab-pane fade show active"
        id="pane-usuarios"
        role="tabpanel"
        aria-labelledby="tab-usuarios"
      >
        <!-- ... seu código de Usuários Pendentes ... -->
        <div id="lista-pendentes-usuarios"></div>
      </div>

      <!-- Pane Reservas Pendentes -->
      <div
        class="tab-pane fade"
        id="pane-reservas-pendentes"
        role="tabpanel"
        aria-labelledby="tab-reservas-pendentes"
      >
        <!-- ... seu código de Reservas Pendentes ... -->
        <div id="lista-pendentes-reservas"></div>
      </div>

      <!-- Pane Reservas Ativas -->
      <div
        class="tab-pane fade"
        id="pane-reservas-ativas"
        role="tabpanel"
        aria-labelledby="tab-reservas-ativas"
      >
        <!-- ... seu código de Reservas Ativas ... -->
        <div id="lista-ativas"></div>
      </div>

      <!-- **Pane Ocupação (nova)** -->
      <div
        class="tab-pane fade"
        id="pane-ocupacao"
        role="tabpanel"
        aria-labelledby="tab-ocupacao"
      >
        <!-- Date Picker para selecionar a data -->
        <div class="d-flex justify-content-end mb-3">
          <label for="occupancy-date-admin" class="me-2 text-gray-700 dark:text-gray-300">
            Data:
          </label>
          <input
            type="date"
            id="occupancy-date-admin"
            class="form-control form-control-sm w-auto"
          />
        </div>

        <!-- Tabela de Ocupação -->
        <div class="overflow-auto border rounded">
          <table id="occupancy-table-admin" class="table table-sm table-bordered mb-0"></table>
        </div>
      </div>
    </div>
  </div>

  <!-- Rodapé simples -->
  <footer class="text-center text-sm text-gray-600 dark:text-gray-400 py-4">
    Copyright© 2025 – Nexus Devsystem – Todos os direitos reservados.
  </footer>

  <!-- Bootstrap JS (para as abas funcionarem) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- main.js (contém Api, CalendarModule, FormModule, DetailModule, buildOccupancyTable, etc.) -->
  <script src="../assets/js/main.js"></script>

  <!-- Script específico para inicializar a aba de “Ocupação” -->
  <script>
    onReady(async () => {
      // 1) Carrega fixedSlots globalmente (para usar na tabela)
      try {
        window.fixedSlots = await Api.fetchFixedSchedules();
      } catch (err) {
        console.error("Falha ao buscar fixedSchedules no admin:", err);
        window.fixedSlots = [];
      }

      // 2) Inicializa o date‐picker para hoje
      const dateInputAdmin = document.getElementById("occupancy-date-admin");
      dateInputAdmin.value = new Date().toISOString().slice(0, 10);

      // 3) Quando a aba “Ocupação” for ativada, chama a função de buildOccupancyTable
      const tabOcupacao = document.getElementById("tab-ocupacao");
      tabOcupacao.addEventListener("shown.bs.tab", () => {
        safeBuildOccupancyTableAdmin(dateInputAdmin.value);
      });

      // 4) Quando a data mudar, refaz a tabela
      dateInputAdmin.addEventListener("change", () => {
        safeBuildOccupancyTableAdmin(dateInputAdmin.value);
      });

      // 5) Se a aba “Ocupação” já estiver selecionada na carga inicial, renderiza imediatamente
      const activeTabId = document.querySelector(".nav-link.active")?.id;
      if (activeTabId === "tab-ocupacao") {
        safeBuildOccupancyTableAdmin(dateInputAdmin.value);
      }
    });

    /**
     * Uma cópia de buildOccupancyTable / safeBuildOccupancyTable, mas adaptada
     * para usar IDs “-admin” (occupancy-date-admin, occupancy-table-admin).
     */
    async function safeBuildOccupancyTableAdmin(filterDate) {
      try {
        await buildOccupancyTableAdmin(filterDate);
      } catch (err) {
        console.error("Erro na tabela de ocupação (admin):", err);
      }
    }

    async function buildOccupancyTableAdmin(filterDate) {
      const table = document.getElementById("occupancy-table-admin");
      if (!table) {
        console.error("#occupancy-table-admin não encontrado");
        return;
      }
      table.innerHTML = "";

      // 1) Pega todas as reservas aprovadas via CalendarModule.getEvents()
      const allEvents = CalendarModule.getEvents();
      // 2) Utiliza a data selecionada (ou hoje, se não houver)
      const dateStr = filterDate || new Date().toISOString().slice(0, 10);
      const [Y, M, D] = dateStr.split("-").map(Number);
      const weekday = new Date(Y, M - 1, D).getDay();

      // 3) Filtra os eventos do dia
      const dayEvents = allEvents.filter((e) => e.date === dateStr);

      // 4) Filtra as “fixed slots” do dia
      const fixedTodaySlots = window.fixedSlots.filter(
        (s) => s.dayOfWeek === weekday
      );

      // 5) Cria os intervalos de 50 minutos (08:00 às 22:00)
      const toDateObj = (Y, M, D, hm) => {
        const [h, m] = hm.split(":").map(Number);
        return new Date(Y, M - 1, D, h, m);
      };

      const padHM = (d) =>
        `${String(d.getHours()).padStart(2, "0")}:${String(d
          .getMinutes()
          .padStart(2, "0"))}`;

      const slotStart = toDateObj(Y, M, D, "08:00");
      const slotEnd = toDateObj(Y, M, D, "22:00");
      const timeRanges = [];
      let cursor = new Date(slotStart);
      while (cursor < slotEnd) {
        const next = new Date(cursor);
        next.setMinutes(cursor.getMinutes() + 50);
        timeRanges.push(`${padHM(cursor)}-${padHM(next)}`);
        cursor = next;
      }

      // 6) Descobre todas as salas envolvidas (reservas + fixed slots)
      const labs = Array.from(
        new Set([
          ...fixedTodaySlots.map((s) => s.lab),
          ...dayEvents.map((e) => e.sala || e.resource),
        ])
      );
      if (!timeRanges.length || !labs.length) {
        table.innerHTML = `
          <tr>
            <td class="p-4 text-center text-white" colspan="${
              timeRanges.length + 1
            }">
              Sem dados para exibir
            </td>
          </tr>`;
        return;
      }

      // 7) Monta o THEAD
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr class="bg-gray-800 text-white sticky-top">
          <th class="px-2 py-1 border text-left">Sala / Horário</th>
          ${timeRanges
            .map(
              (r) =>
                `<th class="px-2 py-1 border text-center text-sm">${r}</th>`
            )
            .join("")}
        </tr>`;
      table.appendChild(thead);

      // 8) Monta o TBODY
      const tbody = document.createElement("tbody");
      labs.forEach((lab) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="px-2 py-1 border font-semibold bg-gray-900 text-white">${lab}</td>`;

        timeRanges.forEach((range) => {
          const [start, end] = range.split("-");
          const cellStart = toDateObj(Y, M, D, start);
          const cellEnd = toDateObj(Y, M, D, end);

          // 8a) Verifica se há uma reserva aprovada nesse intervalo
          const hasReservation = dayEvents.some((ev) => {
            if ((ev.sala || ev.resource) !== lab) return false;
            const evStart = toDateObj(Y, M, D, ev.start);
            const evEnd = toDateObj(Y, M, D, ev.end);
            return evStart < cellEnd && evEnd > cellStart;
          });

          // 8b) Verifica se esse intervalo está em Fixed Slots
          const fixed = fixedTodaySlots.find((fs) => {
            if (fs.lab !== lab) return false;
            const fsStart = toDateObj(Y, M, D, fs.startTime);
            const fsEnd = toDateObj(Y, M, D, fs.endTime);
            return fsStart < cellEnd && fsEnd > cellStart;
          });

          let style = "",
            label = "";
          if (hasReservation) {
            // reserva aprovada = vermelho / “ocupado”
            style = "background-color: rgba(220,38,38,0.8);";
            label = "ocupado";
          } else if (fixed) {
            // horário fixo: cor conforme turno
            const turnoColors = {
              Matutino: "rgba(59,130,246,0.8)",
              Vespertino: "rgba(234,179,8,0.8)",
              Noturno: "rgba(220,38,38,0.8)",
            };
            const corDoTurno = turnoColors[fixed.turno] || "rgba(107,114,128,0.5)";
            style = `background-color: ${corDoTurno};`;
            label = fixed.turno;
          } else {
            // livre = verde
            style = "background-color: rgba(16,185,129,0.8);";
            label = "livre";
          }

          tr.innerHTML += `
            <td class="px-2 py-1 border text-white text-center text-xs" style="${style}">
              ${label}
            </td>`;
        });

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }
  </script>
</body>
</html>
