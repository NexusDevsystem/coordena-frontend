<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Administração</title>

  <!-- Tailwind (caso você esteja usando) e Bootstrap (para abas funcionarem) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script>
    // Aplica imediatamente o tema salvo (evita flash)
    const _theme = localStorage.getItem('theme') || 'light';
    document.documentElement.classList.remove('light');
    if (_theme === 'dark') document.documentElement.classList.add('dark');
  </script>
  <link rel="stylesheet" href="../assets/css/styles.css" />
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <!-- Navbar/Offcanvas Menu do Admin (mantém tudo como estava) -->
  <header class="offcanvas-menu">
    <input type="checkbox" id="toggle-menu" />
    <label for="toggle-menu" class="toggle-open"></label>
    <nav>
      <!-- bloco de usuário e itens de menu—mantenha exatamente como já estava -->
      <div class="menu-user-info p-4">
        <div id="menu-user-name" class="font-semibold"></div>
        <div id="menu-user-email" class="text-sm text-gray-600 dark:text-gray-400"></div>
      </div>
      <label for="toggle-menu" class="toggle-close"></label>
      <ul class="menu-list p-4 space-y-2 list-none">
        <!-- Aqui ficavam outras entradas do menu… -->
      </ul>
      <div class="menu-footer-btns p-4 flex space-x-4">
        <button id="menu-theme-btn" class="footer-btn" aria-label="Alternar tema">
          <!-- Ícones de sol/lua -->
        </button>
        <button id="menu-logout-btn" class="footer-btn logout" aria-label="Sair">
          <!-- Ícone de logout -->
        </button>
      </div>
    </nav>
  </header>

  <!-- Conteúdo principal -->
  <main class="pt-5 px-4">
    <!-- Abas do Admin (mantive as classes exatamente iguais às que você já tinha) -->
    <ul class="nav nav-tabs" id="adminTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="tab-usuarios"
          data-bs-toggle="tab"
          data-bs-target="#pane-usuarios"
          type="button"
          role="tab"
          aria-controls="pane-usuarios"
          aria-selected="true"
        >
          Usuários Pendentes
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="tab-reservas-pendentes"
          data-bs-toggle="tab"
          data-bs-target="#pane-reservas-pendentes"
          type="button"
          role="tab"
          aria-controls="pane-reservas-pendentes"
          aria-selected="false"
        >
          Reservas Pendentes
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="tab-reservas-ativas"
          data-bs-toggle="tab"
          data-bs-target="#pane-reservas-ativas"
          type="button"
          role="tab"
          aria-controls="pane-reservas-ativas"
          aria-selected="false"
        >
          Reservas Ativas
        </button>
      </li>

      <!-- ← Nova aba “Ocupação” (mesmo estilo, mesma estrutura) -->
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="tab-ocupacao"
          data-bs-toggle="tab"
          data-bs-target="#pane-ocupacao"
          type="button"
          role="tab"
          aria-controls="pane-ocupacao"
          aria-selected="false"
        >
          Ocupação
        </button>
      </li>
    </ul>

    <!-- Conteúdo de cada aba do Admin -->
    <div class="tab-content mt-4" id="adminTabContent">

      <!-- Pane: Usuários Pendentes -->
      <div
        class="tab-pane fade show active"
        id="pane-usuarios"
        role="tabpanel"
        aria-labelledby="tab-usuarios"
      >
        <!-- Aqui fica TODO o código que já existia para “Usuários Pendentes” -->
        <div id="lista-pendentes-usuarios"></div>
      </div>

      <!-- Pane: Reservas Pendentes -->
      <div
        class="tab-pane fade"
        id="pane-reservas-pendentes"
        role="tabpanel"
        aria-labelledby="tab-reservas-pendentes"
      >
        <!-- TODO: código que já existia para “Reservas Pendentes” -->
        <div id="lista-pendentes-reservas"></div>
      </div>

      <!-- Pane: Reservas Ativas -->
      <div
        class="tab-pane fade"
        id="pane-reservas-ativas"
        role="tabpanel"
        aria-labelledby="tab-reservas-ativas"
      >
        <!-- TODO: código que já existia para “Reservas Ativas” -->
        <div id="lista-ativas"></div>
      </div>

      <!-- Pane: Ocupação (novo conteúdo) -->
      <div
        class="tab-pane fade"
        id="pane-ocupacao"
        role="tabpanel"
        aria-labelledby="tab-ocupacao"
      >
        <!-- Date‐picker: selecione o dia que quer inspecionar -->
        <div class="flex justify-end mb-3">
          <label for="occupancy-date-admin" class="mr-2 text-gray-700 dark:text-gray-300">
            Data:
          </label>
          <input
            type="date"
            id="occupancy-date-admin"
            class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-400"
          />
        </div>

        <!-- Tabela de Ocupação: cabeçalho e corpo serão gerados por JavaScript -->
        <div class="overflow-auto border rounded">
          <table
            id="occupancy-table-admin"
            class="min-w-full table-auto border-collapse text-xs"
          ></table>
        </div>
      </div>
    </div>
  </main>

  <footer class="text-center text-sm text-gray-600 dark:text-gray-400 py-4">
    Copyright© 2025 – Nexus Devsystem – Todos os direitos reservados.
  </footer>

  <!-- Bootstrap JS (para ativar o comportamento das abas) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- main.js: seu arquivo existente que já contém Api, CalendarModule, FormModule, DetailModule, buildOccupancyTable etc. -->
  <script src="../assets/js/main.js"></script>

  <!-- Script extra para “Ocupação” no Admin (mantendo mesmo estilo de código) -->
  <script>
    // Garante que tudo só rode depois que o DOM estiver carregado
    onReady(async () => {
      // 1) Carrega os horários fixos no escopo global (mesmo que você já carregue no CalendarModule)
      try {
        window.fixedSlots = await Api.fetchFixedSchedules();
      } catch (err) {
        console.error("Falha ao buscar fixedSchedules no admin:", err);
        window.fixedSlots = [];
      }

      // 2) Inicializa o date‐picker para hoje
      const dateInputAdmin = document.getElementById("occupancy-date-admin");
      dateInputAdmin.value = new Date().toISOString().slice(0, 10);

      // 3) Quando a aba “Ocupação” for exibida, constrói a tabela
      const tabOcupacao = document.getElementById("tab-ocupacao");
      tabOcupacao.addEventListener("shown.bs.tab", () => {
        safeBuildOccupancyTableAdmin(dateInputAdmin.value);
      });

      // 4) Quando a data for alterada, reconstrói também
      dateInputAdmin.addEventListener("change", () => {
        safeBuildOccupancyTableAdmin(dateInputAdmin.value);
      });

      // 5) Se a aba “Ocupação” já estiver ativa no carregamento, exibe a tabela imediatamente
      const activeTab = document.querySelector(".nav-link.active")?.id;
      if (activeTab === "tab-ocupacao") {
        safeBuildOccupancyTableAdmin(dateInputAdmin.value);
      }
    });

    /**
     * Versão “admin” de buildOccupancyTable, usando IDs de tabela/data específicos:
     * - #occupancy-date-admin
     * - #occupancy-table-admin
     */
    async function safeBuildOccupancyTableAdmin(filterDate) {
      try {
        await buildOccupancyTableAdmin(filterDate);
      } catch (err) {
        console.error("Erro na tabela de ocupação (admin):", err);
      }
    }

    async function buildOccupancyTableAdmin(filterDate) {
      const table = document.getElementById("occupancy-table-admin");
      if (!table) {
        console.error("#occupancy-table-admin não encontrado");
        return;
      }
      // Limpa o conteúdo anterior
      table.innerHTML = "";

      // 1) Pega todos os eventos aprovados via CalendarModule.getEvents()
      const allEvents = CalendarModule.getEvents();

      // 2) Define a data a ser filtrada (ou hoje, caso não tenha filterDate)
      const dateStr = filterDate || new Date().toISOString().slice(0, 10);
      const [Y, M, D] = dateStr.split("-").map(Number);
      const weekday = new Date(Y, M - 1, D).getDay();

      // 3) Filtra apenas os eventos (reservas) daquele dia
      const dayEvents = allEvents.filter((e) => e.date === dateStr);

      // 4) Filtra também os horários fixos daquele dia da semana
      const fixedTodaySlots = window.fixedSlots.filter(
        (s) => s.dayOfWeek === weekday
      );

      // 5) Monta o array de intervalos de 50 minutos (08:00–22:00)
      function toDateObj(Y, M, D, hm) {
        const [h, m] = hm.split(":").map(Number);
        return new Date(Y, M - 1, D, h, m);
      }
      function padHM(d) {
        return (
          String(d.getHours()).padStart(2, "0") +
          ":" +
          String(d.getMinutes()).padStart(2, "0")
        );
      }

      const slotStart = toDateObj(Y, M, D, "08:00");
      const slotEnd = toDateObj(Y, M, D, "22:00");
      const timeRanges = [];
      let cursor = new Date(slotStart);
      while (cursor < slotEnd) {
        const next = new Date(cursor);
        next.setMinutes(cursor.getMinutes() + 50);
        timeRanges.push(`${padHM(cursor)}-${padHM(next)}`);
        cursor = next;
      }

      // 6) Monta a lista de “laboratórios” (ou salas) do dia:
      //    - todos que aparecem em fixedTodaySlots (propriedade lab)
      //    - todos que aparecem em dayEvents (ou resource ou sala)
      const labs = Array.from(
        new Set([
          ...fixedTodaySlots.map((s) => s.lab),
          ...dayEvents.map((e) => e.sala || e.resource),
        ])
      );
      if (!timeRanges.length || !labs.length) {
        table.innerHTML = `
          <tr>
            <td class="px-4 py-2 text-center text-white bg-gray-800" colspan="${
              timeRanges.length + 1
            }">
              Sem dados para exibir
            </td>
          </tr>`;
        return;
      }

      // 7) Monta o <thead> da tabela
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr class="bg-gray-800 text-white sticky top-0">
          <th class="px-2 py-1 border text-left">Sala / Horário</th>
          ${timeRanges
            .map(
              (r) =>
                `<th class="px-2 py-1 border text-center text-xs">${r}</th>`
            )
            .join("")}
        </tr>`;
      table.appendChild(thead);

      // 8) Monta o <tbody> da tabela
      const tbody = document.createElement("tbody");
      labs.forEach((lab) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-2 py-1 border font-semibold bg-gray-900 text-white">${lab}</td>
        `;

        timeRanges.forEach((range) => {
          const [start, end] = range.split("-");
          const cellStart = toDateObj(Y, M, D, start);
          const cellEnd = toDateObj(Y, M, D, end);

          // 8a) Verifica se há uma reserva (evento aprovado) nesse intervalo
          const hasReservation = dayEvents.some((ev) => {
            if ((ev.sala || ev.resource) !== lab) return false;
            const evStart = toDateObj(Y, M, D, ev.start);
            const evEnd = toDateObj(Y, M, D, ev.end);
            return evStart < cellEnd && evEnd > cellStart;
          });

          // 8b) Verifica se esse intervalo está em Fixed Slots (horário fixo)
          const fixed = fixedTodaySlots.find((fs) => {
            if (fs.lab !== lab) return false;
            const fsStart = toDateObj(Y, M, D, fs.startTime);
            const fsEnd = toDateObj(Y, M, D, fs.endTime);
            return fsStart < cellEnd && fsEnd > cellStart;
          });

          let style = "";
          let label = "";
          if (hasReservation) {
            // Reserva aprovada: vermelho “ocupado”
            style = "background-color: rgba(220,38,38,0.8);";
            label = "ocupado";
          } else if (fixed) {
            // Horário fixo: cor de acordo com turno
            const turnoColors = {
              Matutino: "rgba(59,130,246,0.8)",
              Vespertino: "rgba(234,179,8,0.8)",
              Noturno: "rgba(220,38,38,0.8)",
            };
            const corDoTurno = turnoColors[fixed.turno] || "rgba(107,114,128,0.5)";
            style = `background-color: ${corDoTurno};`;
            label = fixed.turno;
          } else {
            // Livre: verde
            style = "background-color: rgba(16,185,129,0.8);";
            label = "livre";
          }

          tr.innerHTML += `
            <td class="px-2 py-1 border text-white text-center text-xs" style="${style}">
              ${label}
            </td>`;
        });

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }
  </script>
</body>
</html>
